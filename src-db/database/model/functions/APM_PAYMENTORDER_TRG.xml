<?xml version="1.0"?>
  <database name="FUNCTION APM_PAYMENTORDER_TRG">
    <function name="APM_PAYMENTORDER_TRG" type="VARCHAR">
      <body><![CDATA[CORDERLINE VARCHAR(35);
CORDER VARCHAR(35);
V_BUDGET VARCHAR(35);
SUBTOTAL NUMBER;
TOTAL NUMBER;
V_STATUS VARCHAR(5);
BEGIN
	
	IF TG_OP = 'DELETE' THEN

		CORDER := OLD.C_ORDER_ID;

		SELECT EM_APM_BUDGET_ID INTO V_BUDGET
		FROM C_ORDER WHERE C_ORDER_ID = CORDER;

		IF V_BUDGET IS NOT NULL THEN

			SELECT BUDGET_DOCUMENT INTO TOTAL
			FROM APM_BUDGET WHERE APM_BUDGET_ID = V_BUDGET;

			SUBTOTAL := OLD.LINE_GROSS_AMOUNT;
	
			TOTAL := TOTAL - SUBTOTAL;

			--RAISE NO_DATA_FOUND||TOTAL;
	
			UPDATE APM_BUDGET SET BUDGET_DOCUMENT = TOTAL
			WHERE APM_BUDGET_ID = V_BUDGET;
		
		END IF;
	ELSE
		IF TG_OP = 'INSERT' THEN
		CORDERLINE := NEW.C_ORDERLINE_ID;
		ELSE
		CORDERLINE := OLD.C_ORDERLINE_ID;
		END IF;
	
		SELECT C_ORDER_ID,LINE_GROSS_AMOUNT INTO CORDER,SUBTOTAL
		FROM C_ORDERLINE WHERE C_ORDERLINE_ID = CORDERLINE;
		
		SELECT EM_APM_BUDGET_ID,PROCESSED INTO V_BUDGET,V_STATUS
		FROM C_ORDER WHERE C_ORDER_ID = CORDER;

			IF V_BUDGET IS NOT NULL AND V_STATUS = 'Y' THEN

			SELECT BUDGET_DOCUMENT INTO TOTAL
			FROM APM_BUDGET WHERE APM_BUDGET_ID = V_BUDGET;

			TOTAL := TOTAL + SUBTOTAL;

			UPDATE APM_BUDGET SET BUDGET_DOCUMENT = TOTAL,C_ORDER_ID = CORDER
			WHERE APM_BUDGET_ID = V_BUDGET;

		END IF;
	END IF;

IF TG_OP = 'UPDATE' THEN RETURN OLD; ELSE RETURN NEW; END IF;
END APM_PAYMENTORDER_TRG
]]></body>
    </function>
  </database>
