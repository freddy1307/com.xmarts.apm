<?xml version="1.0"?>
  <database name="FUNCTION APM_PAYMENTDOCU">
    <function name="APM_PAYMENTDOCU" type="VARCHAR">
      <body><![CDATA[CINVOICE VARCHAR(35);
CORDER VARCHAR(35);
FINPAY VARCHAR(35);
importe NUMBER;
V_BUDGET VARCHAR(35);
SUBTOTAL NUMBER;
subimporte NUMBER;
MON_O VARCHAR(32);--MONEDA PEDIDO O FACTURA
MON_P VARCHAR(32);--MONEDA PRESUPUESTO
CAMBIO NUMBER;--CANTIDAD DE CAMBIO
Fecha DATE WITHOUT TIME ZONE;--FECHA DE LA FACTURA O PEDIDO
MONEDA_O VARCHAR(32);--NOMBRE DE LA MONEDA DEL PEDIDO O FACTURA
MONEDA_P VARCHAR(32);--NOMBRE DE LA MONEDA DEL PRESUPUESTO
ADCLIENT VARCHAR(32);
BEGIN
	FINPAY := NEW.fin_payment_schedule_ID;

	SELECT C_INVOICE_ID,C_ORDER_ID,amount INTO CINVOICE,CORDER,importe
	FROM fin_payment_schedule WHERE fin_payment_schedule_ID = FINPAY;

	IF CORDER IS NOT NULL THEN

		SELECT EM_APM_BUDGET_ID,c_currency_id,dateordered,AD_CLIENT_ID INTO V_BUDGET,MON_O,fecha,ADCLIENT
		FROM C_ORDER WHERE C_ORDER_ID = CORDER;

		SELECT c_currency_id INTO MON_P
		FROM APM_BUDGET
		WHERE APM_BUDGET_ID =  V_BUDGET;

			IF V_BUDGET IS NOT NULL THEN
		
			IF MON_P IS NULL THEN
			--@APM_PresupuestoSinMoneda@
		 RAISE NO_DATA_FOUND;
			END IF;
			
			IF MON_P = MON_O THEN 
			CAMBIO := 1;
			ELSE			
			
			SELECT multiplyrate INTO cambio FROM C_CONVERSION_RATE WHERE AD_CLIENT_ID = ADCLIENT AND
			VALIDFROM >= fecha AND C_CURRENCY_ID = MON_O AND C_CURRENCY_ID_TO = MON_P order by VALIDTO desc Limit 1;
			--RAISE NO_DATA_FOUND||cambio;
				IF CAMBIO IS NULL THEN
				
				SELECT ISO_CODE INTO MONEDA_O FROM C_CURRENCY WHERE C_CURRENCY_ID = MON_O;
				SELECT ISO_CODE INTO MONEDA_P FROM C_CURRENCY WHERE C_CURRENCY_ID = MON_P;
				--@APM_NoRangoConversion@
			 RAISE NO_DATA_FOUND||MONEDA_P;
				END IF;
			
			END IF;		

			

			SELECT BUDGET_DOCUMENT INTO SUBIMPORTE
			FROM APM_BUDGET WHERE APM_BUDGET_ID = V_BUDGET;

			IMPORTE = IMPORTE / CAMBIO;

			--RAISE NO_DATA_FOUND||cambio;
			
			SUBTOTAL := SUBIMPORTE + IMPORTE;

			UPDATE APM_BUDGET SET BUDGET_DOCUMENT = SUBTOTAL
			WHERE APM_BUDGET_ID = V_BUDGET;

		END IF;
	ELSE
		IF CINVOICE IS NOT NULL THEN

			SELECT EM_APM_BUDGET_ID,c_currency_id,dateinvoiced,AD_CLIENT_ID INTO V_BUDGET,MON_O,fecha,ADCLIENT
			FROM C_INVOICE WHERE C_INVOICE_ID = CINVOICE;


			SELECT c_currency_id INTO MON_P
			FROM APM_BUDGET
			WHERE APM_BUDGET_ID =  V_BUDGET;
			
			IF V_BUDGET IS NOT NULL THEN

					IF MON_P IS NULL THEN
					--@APM_PresupuestoSinMoneda@
				 RAISE NO_DATA_FOUND;
					END IF;
					
					IF MON_P = MON_O THEN 
					CAMBIO := 1;
					
					ELSE
					--RAISE fecha;--||' '||MON_O||' '||mon_P||adclient;
					SELECT multiplyrate INTO cambio FROM C_CONVERSION_RATE WHERE AD_CLIENT_ID = ADCLIENT AND
					VALIDFROM >= fecha AND C_CURRENCY_ID = MON_O AND C_CURRENCY_ID_TO = MON_P order by VALIDTO desc Limit 1;

						IF CAMBIO IS NULL THEN
				
						SELECT ISO_CODE INTO MONEDA_O FROM C_CURRENCY WHERE C_CURRENCY_ID = MON_O;
						SELECT ISO_CODE INTO MONEDA_P FROM C_CURRENCY WHERE C_CURRENCY_ID = MON_P;
						--@APM_NoRangoConversion@
					 RAISE NO_DATA_FOUND||MONEDA_P;
						END IF;
					END IF;	

					SELECT BUDGET_DOCUMENT INTO SUBIMPORTE
					FROM APM_BUDGET WHERE APM_BUDGET_ID = V_BUDGET;

					IMPORTE = IMPORTE / CAMBIO;

					SUBTOTAL := SUBIMPORTE + IMPORTE;

					UPDATE APM_BUDGET SET BUDGET_DOCUMENT = SUBTOTAL
					WHERE APM_BUDGET_ID = V_BUDGET;
			END IF;
		END IF;
	END IF;


RETURN NEW;
IF TG_OP = 'DELETE' THEN RETURN OLD; ELSE RETURN NEW; END IF;
END APM_PAYMENTDOCU
]]></body>
    </function>
  </database>
