<?xml version="1.0"?>
  <database name="FUNCTION APM_PAYMENTEXECUTION">
    <function name="APM_PAYMENTEXECUTION" type="VARCHAR">
      <body><![CDATA[CINVOICE VARCHAR(35);
CORDER VARCHAR(35);
FINPAY VARCHAR(35);
CANT NUMBER;
V_BUDGET VARCHAR(35);
SUBTOTAL NUMBER;
subimporte NUMBER;
V_pago NUMBER;
CANTV NUMBER;
MON_O VARCHAR(32);--MONEDA PEDIDO O FACTURA
MON_P VARCHAR(32);--MONEDA PRESUPUESTO
CAMBIO NUMBER;--CANTIDAD DE CAMBIO
Fecha DATE WITHOUT TIME ZONE;--FECHA DE LA FACTURA O PEDIDO
MONEDA_O VARCHAR(32);--NOMBRE DE LA MONEDA DEL PEDIDO O FACTURA
MONEDA_P VARCHAR(32);--NOMBRE DE LA MONEDA DEL PRESUPUESTO
ADCLIENT VARCHAR(32);
f_pago DATE WITHOUT TIME ZONE;
BEGIN	
	
	FINPAY := OLD.fin_payment_schedule_ID;
	

		SELECT C_INVOICE_ID,C_ORDER_ID,PAIDAMT INTO CINVOICE,CORDER,CANT
		FROM fin_payment_schedule WHERE fin_payment_schedule_ID = FINPAY;

		IF CORDER IS NOT NULL THEN

		SELECT EM_APM_BUDGET_ID,c_currency_id,dateordered,AD_CLIENT_ID INTO V_BUDGET,MON_O,fecha,ADCLIENT
		FROM C_ORDER WHERE C_ORDER_ID = CORDER;

		SELECT c_currency_id INTO MON_P
		FROM APM_BUDGET
		WHERE APM_BUDGET_ID =  V_BUDGET;

		IF V_BUDGET IS NOT NULL THEN

			IF MON_P IS NULL THEN
		 RAISE NO_DATA_FOUND;
			--RAISE NO_DATA_FOUND;
			END IF;
			
			IF MON_P = MON_O THEN 
			CAMBIO := 1;
			ELSE			

			select paymentdate into f_pago from fin_payment_detail_v 
			where fin_payment_sched_ord_v_id=FINPAY
			order by updated desc limit 1;
			
			SELECT multiplyrate INTO cambio FROM C_CONVERSION_RATE WHERE AD_CLIENT_ID = ADCLIENT AND
			VALIDFROM >= f_pago AND C_CURRENCY_ID = MON_O AND C_CURRENCY_ID_TO = MON_P order by VALIDTO desc Limit 1;
			--RAISE NO_DATA_FOUND||;
				IF CAMBIO IS NULL THEN
				
				SELECT ISO_CODE INTO MONEDA_O FROM C_CURRENCY WHERE C_CURRENCY_ID = MON_O;
				SELECT ISO_CODE INTO MONEDA_P FROM C_CURRENCY WHERE C_CURRENCY_ID = MON_P;
				
			 RAISE NO_DATA_FOUND||f_pago;
				--RAISE NO_DATA_FOUND||f_pago;
				END IF;
			
			END IF;	
			
			SELECT BUDGETEXECUTION INTO SUBIMPORTE
			FROM APM_BUDGET WHERE APM_BUDGET_ID = V_BUDGET;

			CANTV := OLD.PAIDAMT;

			IF CANTV IS NULL THEN
			SUBTOTAL := SUBIMPORTE + CANT;
			ELSE
			CANT := CANT - CANTV;
			CANT := CANT / CAMBIO;
			--RAISE NO_DATA_FOUND||CANT;
			SUBTOTAL := SUBIMPORTE + CANT;
			END IF;

			

			--RAISE NO_DATA_FOUND||SUBTOTAL;

			UPDATE APM_BUDGET SET budgetexecution = SUBTOTAL
			WHERE APM_BUDGET_ID = V_BUDGET;

		END IF;
	ELSE
		IF CINVOICE IS NOT NULL THEN

			SELECT EM_APM_BUDGET_ID,c_currency_id,dateinvoiced,AD_CLIENT_ID INTO V_BUDGET,MON_O,fecha,ADCLIENT
			FROM C_INVOICE WHERE C_INVOICE_ID = CINVOICE;

			SELECT c_currency_id INTO MON_P
			FROM APM_BUDGET
			WHERE APM_BUDGET_ID =  V_BUDGET;

			IF V_BUDGET IS NOT NULL THEN

					IF MON_P IS NULL THEN
				 RAISE NO_DATA_FOUND;
				--RAISE EXCEPTION '%','EL presupuesto escogido no tiene seleccionado una moneda
					END IF;
					
					IF MON_P = MON_O THEN 
					CAMBIO := 1;
					
					ELSE

					select paymentdate into f_pago from fin_payment_detail_v 
					where fin_payment_sched_inv_v_id=FINPAY
					order by updated desc limit 1;
					
					--RAISE fecha;--||' '||MON_O||' '||mon_P||adclient;
					SELECT multiplyrate INTO cambio FROM C_CONVERSION_RATE WHERE AD_CLIENT_ID = ADCLIENT AND
					VALIDFROM >= f_pago AND C_CURRENCY_ID = MON_O AND C_CURRENCY_ID_TO = MON_P order by VALIDTO desc Limit 1;

						IF CAMBIO IS NULL THEN
				
						SELECT ISO_CODE INTO MONEDA_O FROM C_CURRENCY WHERE C_CURRENCY_ID = MON_O;
						SELECT ISO_CODE INTO MONEDA_P FROM C_CURRENCY WHERE C_CURRENCY_ID = MON_P;
						
					 RAISE NO_DATA_FOUND||f_pago;
						--RAISE NO_DATA_FOUND||f_pago;
						END IF;
					END IF;	


			SELECT BUDGETEXECUTION INTO SUBIMPORTE
			FROM APM_BUDGET WHERE APM_BUDGET_ID = V_BUDGET;
			
			CANTV := OLD.PAIDAMT;

			IF CANTV IS NULL THEN
			SUBTOTAL := SUBIMPORTE + CANT;
			ELSE
			CANT := CANT - CANTV;
			CANT := CANT / CAMBIO;
			--RAISE NO_DATA_FOUND||CANT;
			SUBTOTAL := SUBIMPORTE + CANT;
			END IF;

			UPDATE APM_BUDGET SET budgetexecution = SUBTOTAL
			WHERE APM_BUDGET_ID = V_BUDGET;

			END IF;

		END IF;
		
	END IF;
RETURN new;

IF TG_OP = 'DELETE' THEN RETURN OLD; ELSE RETURN NEW; END IF;
END APM_PAYMENTEXECUTION
]]></body>
    </function>
  </database>
