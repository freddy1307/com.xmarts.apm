<?xml version="1.0"?>
  <database name="FUNCTION APM_PAYMENTDEL">
    <function name="APM_PAYMENTDEL" type="VARCHAR">
      <body><![CDATA[BUDE NUMBER;
BUDD NUMBER;
V_PAGO NUMBER;
SUBTOTAL NUMBER;
V_BUDGET VARCHAR(35);
CORDER VARCHAR(35);
CINVOICE VARCHAR(35);
FINPAY VARCHAR(35);
BEGIN	
	V_PAGO := OLD.PAIDAMT;
	SUBTOTAL := OLD.AMOUNT;
	FINPAY := OLD.fin_payment_schedule_id;
	CORDER := OLD.C_ORDER_ID;
	CINVOICE := OLD.C_INVOICE_ID;

	IF CORDER IS NOT NULL THEN
		SELECT EM_APM_BUDGET_ID INTO V_BUDGET
		FROM C_ORDER WHERE C_ORDER_ID = CORDER;

	ELSE
		IF CINVOICE IS NOT NULL THEN
		
		SELECT EM_APM_BUDGET_ID INTO V_BUDGET
		FROM C_INVOICE WHERE C_INVOICE_ID = CINVOICE;
		
		END IF;	
	END IF;
	
	SELECT BUDGETEXECUTION,BUDGET_DOCUMENT INTO BUDE,BUDD
	FROM APM_BUDGET WHERE APM_BUDGET_ID = V_BUDGET;

	BUDE := BUDE - V_PAGO;
	BUDD := BUDD - SUBTOTAL;

	--RAISE NO_DATA_FOUND||BUDD;

	UPDATE APM_BUDGET SET budgetexecution = BUDE,BUDGET_DOCUMENT = BUDD
	WHERE APM_BUDGET_ID = V_BUDGET;

	
RETURN OLD; 

IF TG_OP = 'DELETE' THEN RETURN OLD; ELSE RETURN NEW; END IF;
END APM_PAYMENTDEL
]]></body>
    </function>
  </database>
