<?xml version="1.0"?>
  <database name="FUNCTION APM_PAYMENTINVOICE">
    <function name="APM_PAYMENTINVOICE" type="VARCHAR">
      <body><![CDATA[CORDERLINE VARCHAR(35);
CORDER VARCHAR(35);
V_BUDGET VARCHAR(35);
SUBTOTAL NUMBER;
TOTAL NUMBER;
V_STATUS VARCHAR(5);
DOCAC VARCHAR(5);
BEGIN
	
		CORDER := OLD.C_INVOICE_ID;

		SELECT EM_APM_BUDGET_ID,PROCESSED,GRANDTOTAL INTO V_BUDGET,V_STATUS,SUBTOTAL
		FROM C_INVOICE WHERE C_INVOICE_ID = CORDER;

			IF V_BUDGET IS NOT NULL AND V_STATUS = 'Y' THEN

			SELECT BUDGET_DOCUMENT INTO TOTAL
			FROM APM_BUDGET WHERE APM_BUDGET_ID = V_BUDGET;
			
			DOCAC:= NEW.DOCACTION;

		 RAISE NO_DATA_FOUND||DOCAC;
			IF DOCAC = 'RE' THEN
			SUBTOTAL := SUBTOTAL / 4;
			TOTAL := TOTAL + SUBTOTAL;
			ELSE
			TOTAL := TOTAL + SUBTOTAL;
			END IF;

			UPDATE APM_BUDGET SET BUDGET_DOCUMENT = TOTAL
			WHERE APM_BUDGET_ID = V_BUDGET;

			END IF;

RETURN OLD;
IF TG_OP = 'DELETE' THEN RETURN OLD; ELSE RETURN NEW; END IF;
END APM_PAYMENTINVOICE
]]></body>
    </function>
  </database>
